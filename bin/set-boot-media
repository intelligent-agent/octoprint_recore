#!/usr/bin/python3

BOOTDEVICE_USB="extraargs=root=/dev/sda1"
BOOTDEVICE_EMMC="extraargs=root=/dev/mmcblk0p1"
BOOT_ARGS_FILE="/boot/armbianEnv.txt"

import sys

class SetBootMedia:
    def __init__(self, new_media):
        self.new_media = new_media
        if self.get_rootfs() == "emmc":
            self.boot_args_file_path = BOOT_ARGS_FILE
        elif self.get_rootfs() == "usb":
            self.boot_args_file_path = "/mnt"+BOOT_ARGS_FILE

        if new_media == "usb":
            self.set_boot_media(BOOTDEVICE_USB)
        elif new_media == "emmc":
            self.set_boot_media(BOOTDEVICE_EMMC)
        else:
            print("Error, only 'usb' or 'emmc' allowed")

    def get_rootfs(self):
        import re
        for line in open("/proc/mounts", 'r'):
            if re.search('/ ', line):
                if "mmcblk" in line:
                    return "emmc"
                elif "sd" in line:
                    return "usb"
                elif "nvme" in line:
                    return "emmc"
                else:
                    return line
                if line == None:
                    return 'Unknown'

    def get_boot_media(self):
        import re
        for line in open(BOOT_ARGS_FILE, 'r'):
            if re.search('extraargs', line):
                if BOOTDEVICE_USB in line:
                    return "usb"
        return "emmc"

    def change_boot_media(self):
        if self.get_boot_media() == "emmc":
            self.set_boot_media(BOOTDEVICE_USB)
        else:
            self.set_boot_media(BOOTDEVICE_EMMC)

    def set_boot_media(self, new_boot_device):
        self.remove_boot_media()
        with open(self.boot_args_file_path, 'a') as f:
            f.write(new_boot_device+"\n")

    def remove_boot_media(self):
        with open(self.boot_args_file_path,"r+") as f:
            new_f = f.readlines()
            f.seek(0)
            for line in new_f:
                if "extraargs" not in line:
                    f.write(line)
            f.truncate()

    def is_usb_present(self):
        if self.get_rootfs() == "usb":
            return True
        return os.path.isfile("/mnt"+BOOT_ARGS_FILE)

    def is_emmc_present(self):
        if self.get_rootfs() == "emmc":
            return True
        return os.path.isfile("/mnt"+BOOT_ARGS_FILE)


if __name__ == "__main__":
    if len(sys.argv) != 2:
        print("Error: Only one argument allowed")
        exit(1)
    if sys.argv[1] not in ["usb", "emmc"]:
        print("Error: Only 'usb' or 'emmc' allowed")
        exit(2)

    new_media = sys.argv[1]
    SetBootMedia(new_media)
